<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<style>
		body {
			margin: 40px;
		}
		.group {
			display: flex;
			/*flex-direction: row;
			justify-content: space-evenly;*/
		}
		
		code {
			display: none;
		}
		
		.CodeMirror {
			border: 1px solid #444;
			width: 700px;
			height: 400px !important;
			margin-bottom: 30px;
			font-family: Operator Mono SSm A,Operator Mono SSm B,Source Code Pro,Menlo,Consolas,Monaco,monospace !important;
			font-size: 16px;
		}
		
		.graphContainer {
			text-align: center; 
			border: 1px solid #444;
			width: calc(100% - 700px);
			height: 400px;
			margin-left: 50px;
		}
		
		button {
			font-family: Operator Mono SSm A,Operator Mono SSm B,Source Code Pro,Menlo,Consolas,Monaco,monospace !important;
			font-size: 14px;
			padding: 6px 12px;
			margin-bottom: 0;

			display: inline-block;
			text-decoration: none;
			text-align: center;
			white-space: nowrap;
			vertical-align: middle;
			-ms-touch-action: manipulation;
			touch-action: manipulation;
			cursor: pointer;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			background-image: none;
			border: 2px solid transparent;
			border-radius: 4px;
		}
		button:focus,
		button:active:focus {
			outline: thin dotted;
			outline: 5px auto -webkit-focus-ring-color;
			outline-offset: -2px;
		}
		button:hover,
		button:focus {
			color: #333;
			text-decoration: none;
		}
		button:active {
			background-image: none;
			outline: 0;
			-webkit-box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);
			box-shadow: inset 0 3px 5px rgba(0, 0, 0, .125);
		}
		
		/* default
		---------------------------- */
		.btn-default {
			color: #333;
			background-color: #7e7;
			border-color: #ccc;
		}
		.btn-default:focus {
			color: #333;
			background-color: #e6e6e6;
			border-color: #8c8c8c;
		}
		.btn-default:hover {
			color: #333;
			background-color: #e6e6e6;
			border-color: #adadad;
		}
		.btn-default:active {
			color: #333;
			background-color: #e6e6e6;
			border-color: #adadad;
		}
	</style>
	
	<!-- code mirror -->
	<link rel='stylesheet' href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/dracula.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/lesser-dark.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/lucario.min.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/mode/javascript/javascript.min.js"></script>
	
	<!-- sysdiagram -->
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js"></script>
	<script src="https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js"></script>
	
	<script type="text/javascript" src="https://unpkg.com/canvg@3.0.7/lib/umd.js"></script> 

	<script type="text/javascript" src="../../dist/sysdiagram_resources.js"></script>
	<script type="text/javascript" src="../../dist/sysdiagram.js"></script>
	
	<script>
		window.addEventListener('DOMContentLoaded', function(event) {
			var btnRun = document.querySelectorAll("button.run");
			for (var i = 0 ; i < btnRun.length; i++) {
				addButtonRunEvent(i);
			}
			
			var btnDownload = document.querySelectorAll("button.download");
			for (var i = 0 ; i < btnDownload.length; i++) {
				addButtonDownloadEvent(i);
			}
		
			var codeEls = document.querySelectorAll("code");
			for (var i = 0 ; i < codeEls.length; i++) {
				run(i, true);
			}
		});
		
		function addButtonRunEvent(i) {
			var btn = document.querySelectorAll("button.run")[i];
			btn.addEventListener("click", function(evt) {
				run(i, false);
			});
		}
		
		function addButtonDownloadEvent(i) {
			var btn = document.querySelectorAll("button.download")[i];
			btn.addEventListener("click", function(evt) {
				var graphEl = document.querySelectorAll(".graphContainer")[i];
				if (graphEl && graphEl.graphviz) {
					graphEl.graphviz.toImage("example-" + i);
				}
			});
		}
		
		function run(index, init) {
			var codeEl = document.querySelectorAll("code")[index];
			var graphEl = document.querySelectorAll(".graphContainer")[index];
			
			var code = "";
			if (init) {
				code = codeEl.textContent;
				codeEl.innerHTML = null;
				codeEl.style.display = "block";
				codeEl.editor = CodeMirror(codeEl, {
					value: code,
					lineNumbers: true,
					matchBrackets: true,
					//lineWrapping: true,
					extraKeys: {
						"Ctrl-Enter": function(cm) { 
							run(index, false); 
						},     
					},
					theme: "lucario",	// dracula, lesser-dark
				});
				
			} else {
				code = codeEl.editor.getValue();
			}
			
			// Change default attribute(options)
			// sysdiagram.attributes.graphviz.fit = false;
			//sysdiagram.attributes.digraph.splines = "spline";
			
			var result = sysdiagram.render(graphEl, code, {}, function(element, graphviz) {
				var elt = d3.select(element);
				var nodes = elt.selectAll(".node");
				var edges = elt.selectAll(".edge");
				
				nodes.on("click", function() {
					var event = d3.event;
					event.preventDefault();
					event.stopPropagation();
					console.log("node:", event);
				});
				nodes.on("mouseover", function(){
					this.old_stroke = d3.select(this).style("stroke");
					d3.select(this).style("stroke", "crimson");
				})
				.on("mouseout", function(){
					d3.select(this).style("stroke", this.old_stroke);
				});
				
				edges.on("click", function() {
					var event = d3.event;
					event.preventDefault();
					event.stopPropagation();
					console.log("edge:", event);
				});
			});
			var dot = result.dot;	// generated dot script
			var graphviz = result.graphviz;
		}
	</script>
</head>
<body>
	<h1>Sysdiagram Examples</h1>
	
	<h2>Grouped Workers on AWS <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
ctx.attributes.digraph.splines = 'curved'

var EC2 = diagrams.aws.compute.EC2
var RDS = diagrams.aws.database.RDS
var ELB = diagrams.aws.network.ELB

Diagram("Grouped Workers", function() {
	ELB("lb")._$([EC2("worker1"), 
				EC2("worker2"),
				EC2("worker3"),
				EC2("worker4"),
				EC2("worker5")])._$(RDS("events"))
}, {rankdir: "TB"})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Clustered Web Services <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var ECS = diagrams.aws.compute.ECS
var { ElastiCache, RDS } = diagrams.aws.database
var ELB = diagrams.aws.network.ELB
var Route53 = diagrams.aws.network.Route53

Diagram("Clustered Web Services", function() {
	ctx.dns = Route53("dns")
    ctx.lb = ELB("lb")
	
	Cluster("Services", function() {
		ctx.svc_group = [ECS("web1"),
						ECS("web2"),
						ECS("web3")]
	})
	
	Cluster("DB Cluster", function() {
		ctx.db_master = RDS("userdb")
		ctx.db_master._([RDS("userdb ro")])
	})
	
	ctx.memcached = ElastiCache("memcached")
	
	ctx.dns._$(ctx.lb)._$(ctx.svc_group)
    ctx.svc_group._$(ctx.db_master)
    ctx.svc_group._$(ctx.memcached)
	
})
//ctx.onCompleted = function(element, graphviz) { graphviz.toImage('test') }
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Event Processing on AWS <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var { ECS, EKS, Lambda } = diagrams.aws.compute
var Redshift = diagrams.aws.database.Redshift
var SQS = diagrams.aws.integration.SQS
var S3 = diagrams.aws.storage.S3

Diagram("Event Processing", function() {
	ctx.source = EKS("k8s source")
	Cluster("Event Flows", function() {
		Cluster("Event Workers", function() {
			ctx.workers = [ECS("worker1"),
						   ECS("worker2"),
						   ECS("worker3")]
		})
	
		ctx.queue = SQS("event queue")
	
		Cluster("Event Flows", function() {
			ctx.handlers = [Lambda("proc1"),
							Lambda("proc2"),
							Lambda("proc3")]
		})
	})
	
	ctx.store = S3("events store")
    ctx.dw = Redshift("analytics")

    ctx.source._$(ctx.workers)._$(ctx.queue)._$(ctx.handlers)
    ctx.handlers._$(ctx.store)
    ctx.handlers._$(ctx.dw)
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Message Collecting System on GCP <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var { BigQuery, Dataflow, PubSub } = diagrams.gcp.analytics
var {AppEngine, Functions } = diagrams.gcp.compute
var BigTable = diagrams.gcp.database.BigTable
var IotCore = diagrams.gcp.iot.IotCore
var GCS = diagrams.gcp.storage.GCS

Diagram("Message Collecting", () => {
	ctx.pubsub = PubSub("pubsub")
	
	Cluster("Source of Data", () => {
        /*
		ctx.iots = [IotCore("core1"),
					IotCore("core2"),
					IotCore("core3")]
		ctx.iots._$(ctx.pubsub)
		*/
		ArrayNode([IotCore("core1"),
				IotCore("core2"),
				IotCore("core3")])._$(ctx.pubsub)
	})

    Cluster("Targets", () => {
        Cluster("Data Flow", () => {
            ctx.flow = Dataflow("data flow")
		})
		
        Cluster("Data Lake", () => {
            ctx.flow._$([BigQuery("bq"),
                     GCS("storage")])
		})

        Cluster("Event Driven", () => {
            Cluster("Processing", () => {
                ctx.flow._$(AppEngine("engine"))._$(BigTable("bigtable"))
			})

            Cluster("Serverless", () => {
                ctx.flow._$(Functions("func"))._$(AppEngine("appengine"))
			})
		})
	})
    ctx.pubsub._$(ctx.flow)
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Exposed Pod with 3 Replicas on Kubernetes <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var HPA = diagrams.k8s.clusterconfig.HPA
var { Deployment, Pod, ReplicaSet }  = diagrams.k8s.compute
var { Ingress, Service } = diagrams.k8s.network

Diagram("Exposed Pod with 3 Replicas", () => {
	ctx.net = Ingress("domain.com")._$(Service("svc"))
    ctx.net._$([Pod("pod1"),
            Pod("pod2"),
            Pod("pod3")]).$_(ReplicaSet("rs")).$_(Deployment("dp")).$_(HPA("hpa"))
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Stateful Architecture on Kubernetes <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var { Pod, StatefulSet } = diagrams.k8s.compute
var Service = diagrams.k8s.network.Service
var { PV, PVC, StorageClass } = diagrams.k8s.storage

Diagram("Stateful Architecture", () => {
	Cluster("Apps", () => {
        ctx.svc = Service("svc")
        ctx.sts = StatefulSet("sts")

        ctx.apps = []
        for (var i = 0; i < 3; i++) {
            ctx.pod = Pod("pod")
            ctx.pvc = PVC("pvc")
            ctx.pod._(ctx.sts)._(ctx.pvc)
            ctx.apps.push(ctx.svc._$(ctx.pod)._$(ctx.pvc))
		}
	})

    ctx.apps.$_(PV("pv")).$_(StorageClass("sc"))
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Advanced Web Service with On-Premise <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var Spark = diagrams.onprem.analytics.Spark
var Server = diagrams.onprem.compute.Server
var PostgreSQL = diagrams.onprem.database.Postgresql
var Redis = diagrams.onprem.inmemory.Redis
var Fluentd = diagrams.onprem.aggregator.Fluentd
var { Grafana, Prometheus } = diagrams.onprem.monitoring
var Nginx = diagrams.onprem.network.Nginx
var Kafka = diagrams.onprem.queue.Kafka

Diagram("Advanced Web Service with On-Premise", function() {
	ctx.ingress = Nginx("ingress")
	
	ctx.metrics = Prometheus("metric")
	ctx.metrics.$_(Grafana("monitoring"))

	Cluster("Service Cluster", () => {
		ctx.grpcsvc = [
			Server("grpc1"), 
			Server("grpc2"), 
			Server("grpc3")]
	})

	Cluster("Sessions HA", () => {
		ctx.master = Redis("session")
		ctx.master._(Redis("replica")).$_(ctx.metrics)
		ctx.grpcsvc._$(ctx.master)
	})

	Cluster("Database HA", () => {
		ctx.master = PostgreSQL("users")
		ctx.master._(PostgreSQL("slave")).$_(ctx.metrics)
		ctx.grpcsvc._$(ctx.master)
	})
	
	ctx.aggregator = Fluentd("logging")
	ctx.aggregator._$(Kafka("stream"))._$(Spark("analytics"))

	ctx.ingress._$(ctx.grpcsvc)._$(ctx.aggregator)
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>Advanced Web Service with On-Premise (with colors and labels) <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var Spark = diagrams.onprem.analytics.Spark
var Server = diagrams.onprem.compute.Server
var PostgreSQL = diagrams.onprem.database.Postgresql
var Redis = diagrams.onprem.inmemory.Redis
var Fluentd = diagrams.onprem.aggregator.Fluentd
var { Grafana, Prometheus } = diagrams.onprem.monitoring
var Nginx = diagrams.onprem.network.Nginx
var Kafka = diagrams.onprem.queue.Kafka

Diagram("Advanced Web Service with On-Premise (colored)", function() {
	ctx.ingress = Nginx("ingress")
	
	ctx.metrics = Prometheus("metric")
	ctx.metrics.$_(Edge({color: "firebrick", style: "dashed"})).$_(Grafana("monitoring"))

	Cluster("Service Cluster", () => {
		ctx.grpcsvc = [
			Server("grpc1"), 
			Server("grpc2"), 
			Server("grpc3")]
	})

	Cluster("Sessions HA", () => {
		ctx.master = Redis("session")
		ctx.master._(Edge({color: "brown", style: "dashed"}))._(Redis("replica")).$_(Edge({label: "collect"})).$_(ctx.metrics)
		ctx.grpcsvc._$(Edge({color: "brown"}))._$(ctx.master)
	})

	Cluster("Database HA", () => {
		ctx.master = PostgreSQL("users")
		ctx.master._(Edge({color: "brown", style: "dotted"}))._(PostgreSQL("slave")).$_(Edge({label: "collect"})).$_(ctx.metrics)
		ctx.grpcsvc._$(Edge({color: "black"}))._$(ctx.master)
	})
	
	ctx.aggregator = Fluentd("logging")
	ctx.aggregator._$(Edge({label: "parse"}))._$(Kafka("stream"))._$(Edge({color: "black", style: "bold"}))._$(Spark("analytics"))

	ctx.ingress.$_$(Edge({color: "darkgreen"})).$_$(ctx.grpcsvc)._$(Edge({color: "darkorange"}))._$(ctx.aggregator)
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	
	<h2>RabbitMQ Consumers with Custom Nodes <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
var Aurora = diagrams.aws.database.Aurora
var Pod = diagrams.k8s.compute.Pod

// 참고 https://vecta.io/symbols
var rabbitmq_icon = "https://jpadilla.github.io/rabbitmqapp/assets/img/icon.png";

var RabbitMQ = (name, attrs) => Node(name, attrs, "https://jpadilla.github.io/rabbitmqapp/assets/img/icon.png")
var RabbitMQ = function(name, attrs) {
	return Node(name, attrs, "https://jpadilla.github.io/rabbitmqapp/assets/img/icon.png")
}

Diagram("Broker Consumers", function() {
	Cluster("Consumers", function() {
        ctx.consumers = [
            Pod("worker"),
            Pod("worker"),
            Pod("worker")]
	})

    ctx.queue = Custom("Message queue", rabbitmq_icon);
	ctx.queue1 = RabbitMQ("Message queue1", rabbitmq_icon);

    ctx.queue.$_$(ctx.consumers).$_$(Aurora("Database"))
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	<h2>Circled Workers on AWS <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
ctx.attributes.graphviz.engine = 'circo'
ctx.attributes.digraph.splines = 'curved'
		
var EC2 = diagrams.aws.compute.EC2
var RDS = diagrams.aws.database.RDS
var APIGateway = diagrams.aws.network.APIGateway

Diagram("Grouped Workers", function() {
	ctx.worker1 = EC2("worker1")
    ctx.worker4 = EC2("worker4")
  	ctx.worker6 = EC2("worker6")
  
    ctx.worker1.$_$(EC2("worker2")).$_$(EC2("worker3")).$_$(ctx.worker4).$_$(EC2("worker5")).$_$(ctx.worker6)
  	ctx.worker6.$_$(ctx.worker1)
	
	ctx.gateway = APIGateway("gateway")
    ctx.userdb = RDS("userdb")
  	
  	ctx.gateway._$(ctx.worker1)
	ctx.worker4._$(ctx.userdb)
})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	<h2>Company organization chart (with HTML-like labels) <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
ctx.attributes.subgraph.labeljust = 'c'

var Man1 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/88_man-office-worker.513fcaf81c.png")
var Woman1 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/184_woman-office-worker.aba5c81a53.png")

var Man2 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/40_man-office-worker-medium-skin-tone.c786d46670.png");
var Woman2 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/136_woman-office-worker-medium-skin-tone.5c2ed59d9e.png");

var Man3 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/8_man-office-worker-light-skin-tone.ecedebb915.png");
var Woman3 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/104_woman-office-worker-light-skin-tone.0b9478b0dc.png");

var Man4 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/56_man-office-worker-medium-dark-skin-tone.dbc929b244.png");
var Woman4 = (name, attrs) => Node(name, attrs, "https://symbols.getvecta.com/stencil_176/152_woman-office-worker-medium-dark-skin-tone.e47159e659.png");

Diagram("Organization", function() {
  	Cluster("CEO", function() {
      	ctx.ceo = Woman4("Roxy")
    }, {fontcolor: "orange"})
  	
  	Cluster("< &lt;b&gt;Operation Team&lt;/b&gt; >", function() {
      	ctx.team1 = Man1("Hugh")
        ctx.team1.$_(Woman1("Belle"))
        ctx.team1.$_(Man1("Bruno"))
        ctx.team1.$_(Man3("Eric"))
    }, {fontcolor: "#FF0000", tooltip: "Operation Team"})
  
  	Cluster("< &lt;b&gt;Technical Team&lt;/b&gt; >", function() {
     	ctx.team2 = Woman2("Judith")
  		ctx.team2.$_(Man2("Tom"))
		ctx.team2.$_(Man1("Andrew"))
    }, {fontcolor: "blue", tooltip: "Technical Team"})
  
  	Cluster("Commercial Team", function() {
      	ctx.team3 = Man3("Leonard")
		ctx.team3.$_(Woman3("Calla"))
  		ctx.team3.$_(Man2("Mac"))
		ctx.team3.$_(Woman1("Ruby"))
    }, {fontcolor: "green"})
  
  	Cluster("Human Resources Team", function() {
      	ctx.team4 = Man4("Sam")
		ctx.team4.$_(Woman4("Silly"))
  		ctx.team4.$_(Woman2("Maggie"))
    })
  
  	ctx.ceo.$_([ctx.team1, ctx.team2, ctx.team3, ctx.team4])
  
}, {rankdir: "TB"})	
		
		</code>
		<div class="graphContainer"></div>
	</div>
	
	<h2>Grouped Workers by Grouped Lbs <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
ctx.attributes.digraph.splines = 'curved'
		
var { EC2 } = diagrams.aws.compute
var { RDS } = diagrams.aws.database
var { ELB } = diagrams.aws.network

Diagram("Grouped Workers", () => {
    ArrayNode([ELB("lb1"), ELB("lb2")])._$([EC2("worker1"),
                  EC2("worker2"),
                  EC2("worker3"),
                  EC2("worker4"),
                  EC2("worker5")])//._$([RDS("events1"), RDS("events2")])
}, {rankdir: 'TB'})
		</code>
		<div class="graphContainer"></div>
	</div>
	
	<h2>Repeat Custom <button class="btn-default run">Run(Ctrl-Enter)</button> <button class="btn-default download">Image Download</button></h2>
	<div class="group">
		<code>
ctx.attributes.digraph.splines = 'curved'    // Changed graphviz digraph splines

var WEB = (name, attrs) => Node(name, attrs, "images/web.png")
var WAS = (name, attrs) => Node(name, attrs, "images/was.png")
var DB = (name, attrs) => Node(name, attrs, "images/database.png")

Diagram("Repeat Custom", () => {
    Cluster("Web Servers", () => {
        ctx.webs = [WEB("web #1"), WEB("web #2")]
    })
    
    Cluster("WAS Servers", () => {
        ctx.wass = [WAS("WAS #1"), WAS("WAS #2")]
    })
    
    Cluster("DB Servers", () => {
        ctx.dbs = [DB("DB #1"), DB("DB #2")]
    })
    
  ctx.webs._$(ctx.wass)._$(ctx.dbs)
  
}, {rankdir: "LR" })
		</code>
		<div class="graphContainer"></div>
	</div>
</body>
</html>